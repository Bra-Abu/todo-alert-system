<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo Alert System</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body style="opacity: 0; transition: opacity 0.3s ease;">
    <script>
        // Check authentication on page load
        (async function checkAuth() {
            try {
                const response = await fetch('/api/auth/check', {
                    credentials: 'include'
                });
                const data = await response.json();

                if (!data.authenticated) {
                    window.location.href = '/login.html';
                } else {
                    // Store user info
                    window.currentUser = data.user;
                    document.getElementById('userName').textContent = data.user.name || 'User';
                    // Reveal the body after auth check
                    document.body.style.opacity = '1';
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/login.html';
            }
        })();
    </script>

    <!-- Dark Mode Toggle -->
    <div class="theme-toggle">
        <button class="theme-toggle-btn" id="themeToggle" title="Toggle dark mode">
            ğŸŒ™
        </button>
    </div>

    <div class="container">
        <header>
            <div class="header-content">
                <div>
                    <h1>ğŸ“‹ Todo Alert System</h1>
                    <p class="subtitle">Get reminded on WhatsApp & Telegram</p>
                </div>
                <div class="user-menu">
                    <span id="userName" class="user-name">User</span>
                    <a href="/settings.html" class="btn-settings">âš™ï¸ Settings</a>
                    <button id="logoutBtn" class="btn-logout">Logout</button>
                </div>
            </div>
        </header>

        <!-- Add Task Form -->
        <div class="task-form-card">
            <div class="form-header" id="toggleFormBtn" style="cursor: pointer;">
                <h2>â• Add New Task</h2>
                <span id="formArrow">â–¼</span>
            </div>

            <div id="taskFormContent" class="hidden">
                <div class="template-actions">
                    <select id="templateSelect" class="template-select">
                        <option value="">ğŸ’¡ Use Template</option>
                    </select>
                </div>
                <form id="taskForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Task Title *</label>
                        <input type="text" id="title" placeholder="Buy groceries" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Description (optional)</label>
                        <textarea id="description" placeholder="Milk, eggs, bread..." rows="2"></textarea>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Due Date *</label>
                        <input type="date" id="dueDate" required>
                    </div>
                    <div class="form-group">
                        <label>Due Time *</label>
                        <input type="time" id="dueTime" required>
                    </div>
                    <div class="form-group">
                        <label>Recurring</label>
                        <select id="recurring">
                            <option value="none">One-time</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Priority *</label>
                        <select id="priority">
                            <option value="low">ğŸŸ¢ Low</option>
                            <option value="medium" selected>ğŸŸ¡ Medium</option>
                            <option value="high">ğŸ”´ High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Category *</label>
                        <select id="category">
                            <option value="general">General</option>
                            <option value="work">ğŸ’¼ Work</option>
                            <option value="personal">ğŸ‘¤ Personal</option>
                            <option value="health">â¤ï¸ Health</option>
                            <option value="shopping">ğŸ›’ Shopping</option>
                            <option value="study">ğŸ“š Study</option>
                            <option value="finance">ğŸ’° Finance</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Reminder (minutes before)</label>
                        <select id="reminderMinutes">
                            <option value="0">No reminder</option>
                            <option value="5">5 minutes</option>
                            <option value="10">10 minutes</option>
                            <option value="15">15 minutes</option>
                            <option value="30">30 minutes</option>
                            <option value="60">1 hour</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Notes (optional)</label>
                        <textarea id="notes" placeholder="Additional notes..." rows="2"></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label>Subtasks (optional)</label>
                    <div id="subtasksList" class="subtasks-list"></div>
                    <button type="button" id="addSubtaskBtn" class="btn btn-outline btn-small">+ Add Subtask</button>
                </div>

                <button type="submit" class="btn btn-primary">Add Task</button>
            </form>
            </div>
        </div>

        <!-- Test Alerts -->
        <div class="test-alerts">
            <button id="testWhatsApp" class="btn btn-secondary">ğŸŸ¢ Test WhatsApp</button>
            <button id="testTelegram" class="btn btn-secondary">âœˆï¸ Test Telegram</button>
            <button id="testSMS" class="btn btn-secondary">ğŸ“± Test SMS</button>
            <button id="requestNotificationPermission" class="btn btn-secondary">ğŸ”” Enable Notifications</button>
        </div>

        <!-- Task List -->
        <div class="tasks-section">
            <div class="section-header">
                <h2>ğŸ“Œ Pending Tasks</h2>
                <button id="refreshBtn" class="btn btn-small">ğŸ”„ Refresh</button>
            </div>

            <!-- Search and Filter Controls -->
            <div class="controls-bar">
                <input type="text" id="searchBox" class="search-box" placeholder="ğŸ” Search tasks...">
                <div class="filter-group">
                    <select id="filterRecurring" class="filter-select">
                        <option value="all">All Types</option>
                        <option value="none">One-time</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                    <select id="sortBy" class="sort-select">
                        <option value="date-asc">Date (Earliest)</option>
                        <option value="date-desc">Date (Latest)</option>
                        <option value="title-asc">Title (A-Z)</option>
                        <option value="title-desc">Title (Z-A)</option>
                        <option value="created-asc">Created (Oldest)</option>
                        <option value="created-desc">Created (Newest)</option>
                    </select>
                    <button id="bulkSelectToggle" class="btn btn-outline btn-small">âœ“ Select Multiple</button>
                </div>
            </div>

            <!-- Bulk Actions Bar -->
            <div id="bulkActionsBar" class="bulk-actions-bar hidden">
                <span class="bulk-info"><span id="selectedCount">0</span> tasks selected</span>
                <button id="bulkComplete" class="btn btn-success btn-small">âœ“ Complete Selected</button>
                <button id="bulkDelete" class="btn btn-danger btn-small">ğŸ—‘ï¸ Delete Selected</button>
                <button id="cancelBulk" class="btn btn-outline btn-small">Cancel</button>
            </div>

            <div id="tasksList" class="tasks-list">
                <p class="loading">Loading tasks...</p>
            </div>
        </div>

        <!-- Completed Tasks -->
        <div class="tasks-section">
            <div class="section-header">
                <h2>âœ… Completed Tasks</h2>
            </div>
            <div id="completedTasksList" class="tasks-list">
                <p class="loading">Loading...</p>
            </div>
        </div>

        <!-- Performance Reports -->
        <div class="tasks-section">
            <div class="section-header">
                <h2>ğŸ“Š Performance Reports</h2>
                <div class="report-controls">
                    <select id="reportPeriod" class="report-select">
                        <option value="daily">Daily (Last 7 days)</option>
                        <option value="weekly">Weekly (Last 4 weeks)</option>
                        <option value="monthly" selected>Monthly (Last 6 months)</option>
                        <option value="annual">Annual (Last 2 years)</option>
                    </select>
                    <button id="loadReportBtn" class="btn btn-small">Load Report</button>
                </div>
            </div>

            <!-- Summary Stats -->
            <div id="summaryStats" class="summary-grid">
                <div class="summary-card">
                    <div class="summary-value" id="totalTasks">-</div>
                    <div class="summary-label">Total Tasks</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="completedTasks">-</div>
                    <div class="summary-label">Completed</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="pendingTasks">-</div>
                    <div class="summary-label">Pending</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="overdueTasks">-</div>
                    <div class="summary-label">Overdue</div>
                </div>
                <div class="summary-card highlight">
                    <div class="summary-value" id="completionRate">-</div>
                    <div class="summary-label">Completion Rate</div>
                </div>
            </div>

            <!-- Period Statistics -->
            <div id="periodStats" class="period-stats">
                <p class="loading">Select a period and click "Load Report"</p>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âœï¸ Edit Task</h2>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <form id="editTaskForm">
                <input type="hidden" id="editTaskId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Task Title *</label>
                        <input type="text" id="editTitle" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Description (optional)</label>
                        <textarea id="editDescription" rows="3"></textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Due Date *</label>
                        <input type="date" id="editDueDate" required>
                    </div>
                    <div class="form-group">
                        <label>Due Time *</label>
                        <input type="time" id="editDueTime" required>
                    </div>
                    <div class="form-group">
                        <label>Recurring</label>
                        <select id="editRecurring">
                            <option value="none">One-time</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Priority *</label>
                        <select id="editPriority">
                            <option value="low">ğŸŸ¢ Low</option>
                            <option value="medium">ğŸŸ¡ Medium</option>
                            <option value="high">ğŸ”´ High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Category *</label>
                        <select id="editCategory">
                            <option value="general">General</option>
                            <option value="work">ğŸ’¼ Work</option>
                            <option value="personal">ğŸ‘¤ Personal</option>
                            <option value="health">â¤ï¸ Health</option>
                            <option value="shopping">ğŸ›’ Shopping</option>
                            <option value="study">ğŸ“š Study</option>
                            <option value="finance">ğŸ’° Finance</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Reminder</label>
                        <select id="editReminderMinutes">
                            <option value="0">No reminder</option>
                            <option value="5">5 minutes</option>
                            <option value="10">10 minutes</option>
                            <option value="15">15 minutes</option>
                            <option value="30">30 minutes</option>
                            <option value="60">1 hour</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Notes (optional)</label>
                        <textarea id="editNotes" rows="3"></textarea>
                    </div>
                </div>
                <div class="form-group">
                    <label>Subtasks</label>
                    <div id="editSubtasksList" class="subtasks-list"></div>
                    <button type="button" id="editAddSubtaskBtn" class="btn btn-outline btn-small">+ Add Subtask</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" id="cancelEdit">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    const response = await fetch('/api/auth/logout', {
                        method: 'POST',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        window.location.href = '/login.html';
                    }
                } catch (error) {
                    console.error('Logout failed:', error);
                    alert('Logout failed. Please try again.');
                }
            }
        });
    </script>
</body>
</html>
